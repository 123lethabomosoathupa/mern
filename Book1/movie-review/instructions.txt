# CHAPTERS 18-20: MOVIE COMPONENT, REVIEWS LISTING, AND LOGIN

## CHAPTER 18: MOVIE COMPONENT

The Movie component displays a single movie with its poster, plot, and all reviews. Users can add reviews if logged in.

### Complete movie.js

Replace the contents of `frontend/src/components/movie.js`:

```javascript
import React, { useState, useEffect } from 'react';
import MovieDataService from '../services/movies';
import { Link } from 'react-router-dom';
import Card from 'react-bootstrap/Card';
import Container from 'react-bootstrap/Container';
import Image from 'react-bootstrap/Image';
import Col from 'react-bootstrap/Col';
import Row from 'react-bootstrap/Row';
import Button from 'react-bootstrap/Button';
import Media from 'react-bootstrap/Media';
import moment from 'moment';

const Movie = props => {
  
  const [movie, setMovie] = useState({
    id: null,
    title: "",
    rated: "",
    reviews: []
  });

  const getMovie = id => {
    MovieDataService.get(id)
      .then(response => {
        setMovie(response.data);
        console.log(response.data);
      })
      .catch(e => {
        console.log(e);
      });
  }

  useEffect(() => {
    getMovie(props.match.params.id);
  }, [props.match.params.id]);

  const deleteReview = (reviewId, index) => {
    MovieDataService.deleteReview(reviewId, props.user.id)
      .then(response => {
        setMovie((prevState) => {
          prevState.reviews.splice(index, 1);
          return ({
            ...prevState
          });
        });
      })
      .catch(e => {
        console.log(e);
      });
  }

  return (
    <div>
      <Container>
        <Row>
          <Col>
            <Image src={movie.poster + "/100px250"} fluid />
          </Col>
          <Col>
            <Card>
              <Card.Header as="h5">{movie.title}</Card.Header>
              <Card.Body>
                <Card.Text>
                  {movie.plot}
                </Card.Text>
                {props.user && 
                  <Link to={"/movies/" + props.match.params.id + "/review"}>
                    Add Review
                  </Link>
                }
              </Card.Body>
            </Card>
            <br />
            <h2>Reviews</h2>
            <br />
            {movie.reviews.map((review, index) => {
              return (
                <Media key={index}>
                  <Media.Body>
                    <h5>
                      {review.name + " reviewed on "}
                      {moment(review.date).format("Do MMMM YYYY")}
                    </h5>
                    <p>{review.review}</p>
                    {props.user && props.user.id === review.user_id &&
                      <Row>
                        <Col>
                          <Link to={{
                            pathname: "/movies/" + props.match.params.id + "/review",
                            state: { currentReview: review }
                          }}>Edit</Link>
                        </Col>
                        <Col>
                          <Button variant="link" onClick={() => deleteReview(review._id, index)}>
                            Delete
                          </Button>
                        </Col>
                      </Row>
                    }
                  </Media.Body>
                </Media>
              )
            })}
          </Col>
        </Row>
      </Container>
    </div>
  );
}

export default Movie;
```

### Install Moment.js

For date formatting, install moment.js:

```bash
# In frontend directory
npm install moment
```

### Code Explanation

**State Initialization:**
```javascript
const [movie, setMovie] = useState({
  id: null,
  title: "",
  rated: "",
  reviews: []
});
```
- Initializes movie state with default values
- `reviews` is an empty array until data loads

**getMovie Function:**
```javascript
const getMovie = id => {
  MovieDataService.get(id)
    .then(response => {
      setMovie(response.data);
      console.log(response.data);
    })
    .catch(e => {
      console.log(e);
    });
}
```
- Calls `MovieDataService.get(id)` which fetches movie by ID
- Backend uses MongoDB `$lookup` to join reviews
- Response contains movie data with embedded reviews array

**useEffect with Dependency:**
```javascript
useEffect(() => {
  getMovie(props.match.params.id);
}, [props.match.params.id]);
```
- `props.match.params.id`: Movie ID from URL
- Runs when component mounts
- Runs again if movie ID changes (different movie)
- Dependency array `[props.match.params.id]` prevents unnecessary re-renders

**deleteReview Function:**
```javascript
const deleteReview = (reviewId, index) => {
  MovieDataService.deleteReview(reviewId, props.user.id)
    .then(response => {
      setMovie((prevState) => {
        prevState.reviews.splice(index, 1);
        return ({
          ...prevState
        });
      });
    })
    .catch(e => {
      console.log(e);
    });
}
```
- Calls API to delete review from database
- `prevState`: Previous movie state
- `splice(index, 1)`: Removes review at index
- `...prevState`: Spread operator copies state
- Updates UI immediately without page refresh

**Movie Display:**
```javascript
<Row>
  <Col>
    <Image src={movie.poster + "/100px250"} fluid />
  </Col>
  <Col>
    <Card>
      <Card.Header as="h5">{movie.title}</Card.Header>
      <Card.Body>
        <Card.Text>{movie.plot}</Card.Text>
        {props.user && 
          <Link to={"/movies/" + props.match.params.id + "/review"}>
            Add Review
          </Link>
        }
      </Card.Body>
    </Card>
  </Col>
</Row>
```
- Two columns: poster on left, details on right
- `fluid`: Makes image responsive
- Shows "Add Review" link only if user is logged in

**Reviews Mapping:**
```javascript
{movie.reviews.map((review, index) => {
  return (
    <Media key={index}>
      <Media.Body>
        <h5>
          {review.name + " reviewed on "}
          {moment(review.date).format("Do MMMM YYYY")}
        </h5>
        <p>{review.review}</p>
        {/* Edit/Delete buttons */}
      </Media.Body>
    </Media>
  )
})}
```
- Maps through reviews array
- `moment()`: Formats date (e.g., "10th May 2021")
- Each review shows reviewer name, date, and review text

**Edit/Delete Buttons:**
```javascript
{props.user && props.user.id === review.user_id &&
  <Row>
    <Col>
      <Link to={{
        pathname: "/movies/" + props.match.params.id + "/review",
        state: { currentReview: review }
      }}>Edit</Link>
    </Col>
    <Col>
      <Button variant="link" onClick={() => deleteReview(review._id, index)}>
        Delete
      </Button>
    </Col>
  </Row>
}
```
- Only shows if user is logged in AND user owns the review
- **Edit**: Links to add-review component with current review in state
- **Delete**: Calls deleteReview with review ID and array index

---

## CHAPTER 19: LISTING REVIEWS

The reviews are already displayed in Chapter 18's code above. This chapter focuses on formatting and understanding the review display.

### Review Display Features

**Date Formatting with Moment.js:**
```javascript
import moment from 'moment';

// In the component:
{moment(review.date).format("Do MMMM YYYY")}
```
- Converts: `2021-05-10T00:08:50.082Z`
- To: `10th May 2021`
- Other formats: `"YYYY-MM-DD"`, `"MMM DD, YYYY"`, etc.

**Conditional Rendering:**
```javascript
{props.user && props.user.id === review.user_id &&
  // Show Edit/Delete buttons
}
```
- First condition: `props.user` - User is logged in
- Second condition: `props.user.id === review.user_id` - User owns review
- Both must be true to show buttons

**Media Component:**
```javascript
<Media key={index}>
  <Media.Body>
    {/* Review content */}
  </Media.Body>
</Media>
```
- Bootstrap Media component for content blocks
- Good for displaying user-generated content
- Provides consistent spacing and layout

### Example Review Display

When you view a movie with reviews, you'll see:

```
[Movie Poster]    The Great Train Robbery
                  A group of bandits stage a brazen train hold-up...
                  
                  Add Review (if logged in)

                  Reviews
                  
                  john reviewed on 10th May 2021
                  Great movie!
                  [Edit] [Delete] (only if you're john)
                  
                  jane reviewed on 11th May 2021
                  Amazing cinematography!
                  [Edit] [Delete] (only if you're jane)
```

---

## CHAPTER 20: LOGIN COMPONENT

A simple login system that stores user information in state. This is a placeholder for a full authentication system.

### Complete login.js

Replace the contents of `frontend/src/components/login.js`:

```javascript
import React, { useState } from 'react';
import Form from 'react-bootstrap/Form';
import Button from 'react-bootstrap/Button';

const Login = props => {
  
  const [name, setName] = useState("");
  const [id, setId] = useState("");

  const onChangeName = e => {
    const name = e.target.value;
    setName(name);
  }

  const onChangeId = e => {
    const id = e.target.value;
    setId(id);
  }

  const login = () => {
    props.login({ name: name, id: id });
    props.history.push('/');
  }

  return (
    <div>
      <Form>
        <Form.Group>
          <Form.Label>Username</Form.Label>
          <Form.Control
            type="text"
            placeholder="Enter username"
            value={name}
            onChange={onChangeName}
          />
        </Form.Group>

        <Form.Group>
          <Form.Label>ID</Form.Label>
          <Form.Control
            type="text"
            placeholder="Enter id"
            value={id}
            onChange={onChangeId}
          />
        </Form.Group>

        <Button variant="primary" onClick={login}>
          Submit
        </Button>
      </Form>
    </div>
  );
}

export default Login;
```

### Code Explanation

**State Variables:**
```javascript
const [name, setName] = useState("");
const [id, setId] = useState("");
```
- `name`: Username entered by user
- `id`: User ID (in production, this would be generated)

**onChange Handlers:**
```javascript
const onChangeName = e => {
  const name = e.target.value;
  setName(name);
}

const onChangeId = e => {
  const id = e.target.value;
  setId(id);
}
```
- Updates state when user types in fields
- Creates controlled components (state controls value)

**login Function:**
```javascript
const login = () => {
  props.login({ name: name, id: id });
  props.history.push('/');
}
```
- `props.login`: Function passed from App.js
- Creates user object: `{ name: "john", id: "1234" }`
- Calls `setUser()` in App.js to update user state
- `props.history.push('/')`: Redirects to home page
- User is now "logged in"

**Form Fields:**
```javascript
<Form.Group>
  <Form.Label>Username</Form.Label>
  <Form.Control
    type="text"
    placeholder="Enter username"
    value={name}
    onChange={onChangeName}
  />
</Form.Group>
```
- `value={name}`: Controlled input (state drives value)
- `onChange={onChangeName}`: Updates state on input
- Two-way data binding

**Submit Button:**
```javascript
<Button variant="primary" onClick={login}>
  Submit
</Button>
```
- Calls login function on click
- No form submission (prevents page reload)

### How Login Works

**Login Flow:**

1. User enters username: "john"
2. User enters ID: "1234"
3. User clicks Submit
4. `login()` is called:
   ```javascript
   props.login({ name: "john", id: "1234" })
   ```
5. In App.js, `setUser()` updates user state
6. User is redirected to home page
7. Navbar now shows "Logout User" instead of "Login"
8. User can now add/edit/delete their reviews

**Logout Flow:**

1. User clicks "Logout User" in navbar
2. `logout()` function in App.js is called:
   ```javascript
   async function logout() {
     setUser(null);
   }
   ```
3. User state is set to null
4. Navbar shows "Login" again
5. "Add Review" links disappear
6. Edit/Delete buttons on reviews disappear

### Important Note

**This is a simplified login system:**
- ❌ No password verification
- ❌ No session persistence (refresh logs out)
- ❌ No server-side authentication
- ❌ No security measures

**For production, implement:**
- ✅ Real authentication (JWT, OAuth, Firebase)
- ✅ Password hashing
- ✅ Session management
- ✅ HTTPS
- ✅ CSRF protection

---

## TESTING YOUR APP

### Test Complete Flow

**1. View Movies:**
- Go to `http://localhost:3000`
- Should see movie cards

**2. View Movie Details:**
- Click "View Reviews" on any movie
- Should see movie poster, plot, and reviews (if any)

**3. Login:**
- Click "Login" in navbar
- Enter username: "john"
- Enter ID: "1234"
- Click Submit
- Should redirect to home page
- Navbar should show "Logout User"

**4. Add Review:**
- Go to a movie detail page
- Should now see "Add Review" link
- Click it (we'll implement this in next chapter)

**5. View Your Reviews:**
- If you created reviews with user_id "1234" in Postman
- You should see Edit/Delete buttons on those reviews

**6. Delete Review:**
- Click Delete on a review you own
- Review should disappear immediately
- Check MongoDB Atlas - review should be deleted

**7. Logout:**
- Click "Logout User"
- "Add Review" links should disappear
- Edit/Delete buttons should disappear

### Debug Tips

**Check Console:**
- Open Developer Tools (F12)
- Console tab shows API responses
- Look for errors

**Check Network Tab:**
- See actual API calls
- Verify request/response data

**Common Issues:**

**Reviews not showing:**
- Create reviews in Postman first (Chapter 11)
- Make sure movie_id matches

**Delete not working:**
- Verify user_id matches review owner
- Check browser console for errors

**Login doesn't persist:**
- Normal behavior (no session storage)
- Will logout on page refresh
- Will implement properly in later versions

---

## PROJECT STATUS

### Completed Components

✅ **App.js** - Main app with routing and user state
✅ **MoviesList** - Search and display movies
✅ **Movie** - Display single movie with reviews
✅ **Login** - Simple login form

### Remaining Components

⏳ **AddReview** - Create and edit reviews (next chapter)

### Features Working

✅ View all movies
✅ Search by title
✅ Filter by rating
✅ View movie details
✅ Display reviews with formatted dates
✅ Login/logout
✅ Delete reviews (for owners only)
✅ Conditional rendering based on login state

---

## COMPLETE FILE STRUCTURE

```
movie-reviews/
├── backend/
│   └── ... (completed in Chapters 1-12)
└── frontend/
    ├── src/
    │   ├── components/
    │   │   ├── movies-list.js ✅
    │   │   ├── movie.js ✅
    │   │   ├── add-review.js ⏳
    │   │   └── login.js ✅
    │   ├── services/
    │   │   └── movies.js ✅
    │   ├── App.js ✅
    │   └── index.js ✅
    └── package.json
```

---

## SUMMARY

✅ **Chapter 18: Movie Component**
- Displays single movie with poster and plot
- Fetches movie data with embedded reviews using MongoDB $lookup
- Implements delete review functionality
- Shows "Add Review" link for logged-in users
- Shows Edit/Delete only for review owners

✅ **Chapter 19: Listing Reviews**
- Reviews displayed in Movie component
- Date formatting with moment.js
- Conditional rendering based on ownership
- Media component for consistent layout

✅ **Chapter 20: Login Component**
- Simple form with username and ID fields
- Updates user state in App.js
- Redirects to home after login
- Enables review creation/editing/deletion

**Next Steps:**
In Chapter 21, you'll implement the AddReview component to create and edit reviews with a form interface.

Your app is almost complete! Users can now browse movies, view reviews, login, and delete their own reviews.